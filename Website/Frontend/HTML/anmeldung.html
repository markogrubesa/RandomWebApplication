<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="../CSS/navileiste.css">
    <link rel="stylesheet" type="text/css" href="../CSS/anmeldung.css">
    <link rel="stylesheet" type="text/css" href="../CSS/fussleiste.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="../Javascript/sessionHandling.js"></script>
    <script src="../Javascript/suche.js"></script>
    <script src="../Javascript/anmeldung.js"></script>
    <script src="../Javascript/account.js"></script> <!--Für Logout-->

    <meta charset="utf-8">
    <title>HS-Shop: Anmelden/Registrieren</title>
</head> 

<body>
    <!--FLEXBOX-->
    <nav>
        <div class="flexbox">
            <div class="logo" >
                <div class="logo_img"><a title="Home" href="../HTML/index.html"><img src="../Bilder/navi_logo_shop.png" alt="An Error occured!"></a></div>
            </div>
    
            <div class="menu">
                <div class="menu_top">
    
                    <div class="menu_top_left">
                        <a href="../HTML/kontakt.html">Kontakt</a>
                        <a href="https://www.hs-albsig.de/hochschule/ueber-uns/hochschulportrait">Über die Hochschule</a>
                    </div>
    
                    <div class="menu_top_right">
                        <div class="searchbar"><form action="../HTML/suche.html" method="">
                            <input type="search" id="suche" maxlength="50" placeholder="Suche..">
                            <button type="submit" onclick="search()">Go!</button></form></div>
                        <div class="tooltip">
                            <a title="Account" href="../HTML/account.html"><img src="../Bilder/navi_account.png" alt="Account"></a>
                            <span class="tooltiptext">
                                <a href="../HTML/anmeldung.html"><button>Anmelden/Registrieren</button></a><br>
                                <input type="button" onclick="logout()" value="Ausloggen">
                            </span>

                        </div>
                    </div>
                </div>
    
                <hr width="95%">
    
                <div class="menu_bottom">
                    <div class="menu_item"><a href="produkt_hauptseite.html" onclick="selectPath('Sale')">Sale</a></div>
                    <div class="menu_item"><a href="produkt_hauptseite.html" onclick="selectPath('Männer')">Männer</a></div>
                    <div class="menu_item"><a href="produkt_hauptseite.html" onclick="selectPath('Frauen')">Frauen</a></div>
                    <div class="menu_item"><a href="produkt_hauptseite.html" onclick="selectPath('Accessoires')">Accessoires</a></div>
                    <div class="menu_item"><a title="Warenkorb" href="../HTML/warenkorb.html"><img src="../Bilder/navi_warenkorb.png" alt="Cart"></a></div>
                </div>
            </div>
                
        </div>
    </nav>
    <!--ENDE FLEXBOX-->

    <!--FORMULAR-->
    <div class="content">
        
        <!--Anmeldung-->
        <div class="anmeldung">
            <h3>Anmelden</h3>
            <div class="anmeldung_content">
                <form class="anmeldeformular" action="" method="">
                    <text>Benutzername oder E-Mail-Adresse:</text><br>
                    <input type="text" name="anmelden" maxlength="40"><br>
                    <text>Passwort:</text><br>
                    <input type="password" name="anmelden" minlength="8"><br>
                    <a href="../HTML/reset_change_password.html">Passwort vergessen?</a><br>
                    <input type="submit" value="Anmelden">
                </form>
            </div>
        </div>

        <!--oder text-->
        <div class="oder">
            <hr>
            <b>ODER</b>
            <hr>
        </div>

        <!--Registrierung-->
        <div class="registrierung">
            <h3>Registrieren</h3>
            <div class="registrierung_content">

                <form class="registformular" name="registrierungsform" id="registrierungsform" >
                    <div class="form_anrede">
                        <text>Anrede</text><br>
                        <label>Herr</label><input type="radio" class="anrede" name="anrede" value="Herr" checked>
                        <label>Frau</label><input type="radio" class="anrede" name="anrede" value="Frau">
                    </div>

                    <div class="form_vorname">
                        <text>Vorname</text><br>
                        <input type="text" id="vorname" name="vorname" maxlength="40" required>
                    </div>

                    <div class="form_nachname">
                        <text>Nachname</text><br>
                        <input type="text" id="nachname" name="nachname" maxlength="40" required>
                    </div>

                    <div class="form_benutzername">
                        <text>Benutzername</text><br>
                        <input type="text" id="benutzername" name="benutzername" maxlength="20" required onkeyup="checkUsername()">
                    </div>

                    <div class="email">
                        <text>E-Mail</text><br>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="passwort">
                        <text>Passwort</text><br>
                        <input type="password" id="passwort" name="passwort" minlength="8" required onkeyup="comparePasswords()"> 
                    </div>

                    <div class="passwort">
                        <text>Passwort Wiederholung</text><br>
                        <input type="password" id="passwort_wdh" name="passwort" minlength="8" required onkeyup="comparePasswords()"><br>
                        <b id="alertPassword" style="color: red; font-size: 13px;"></b> <!--Für die Ausgabe comparePasswords() in anmeldung.js-->
                    </div>

                    <div class="sicherheitsfrage">
                        <text>Sicherheitsfrage</text><br>
                        <select id="sicherheitsfrage" name="sicherheitsfrage">
                            <option value="" selected="on"></option>
                            <option value="Wann hast du dein Handy gekauft? (Jahr angeben)">Wann hast du dein Handy gekauft? (Jahr angeben)</option>
                            <option value="Wo bist du geboren?">Wo bist du geboren?</option>
                            <option value="Wie ist der Geburtsname Ihrer Mutter?">Wie ist der Geburtsname Ihrer Mutter?</option>
                        </select>
                    </div>

                    <div class="sicherheitsantwort">
                        <text>Antwort</text><br>
                        <input type="text" id="sicherheitsantwort" name="sicherheitsantwort" required>
                    </div>
					
					<div class="form_strasse">
                        <text>Straße, Hausnummer</text><br>
                        <input type="text" id="strasse" name="strasse" required>
                    </div>
					
					<div class="form_plz">
                        <text>PLZ</text><br>
                        <input type="number" id="plz" name="plz" maxlength="5" required>
                    </div>
					
					<div class="form_ort">
                        <text>Ort</text><br>
                        <input type="text" id="ort" name="ort" required>
                    </div>
				

                    <div class="agb">
                        <input type="checkbox" name="agb" required>
                        Ich stimme den <a href="../HTML/agb.html">AGBs</a> zu.
                    </div>

                    <div class="submit">
                        <input type="submit" id="submit" value="Registrieren" >
                    </div>
                    
                </form>
            </div>
        </div>

    </div>
    <!--ENDE FORMULAR-->


    
    <script>
        $(document).ready(function(){
            $('#registrierungsform').submit(function() {
            //$('#submit').click(function() {
                console.log("[sta] Ready!");

                //read form
                function checkedRadio(){
                    const anrede = document.getElementsByName('anrede');
                    for (i=0; i < anrede.length; i++){
                        if (anrede[i].checked){return anrede[i].value;}
                    }
                }
                const anrede = checkedRadio();
                const vorname = $('#vorname').val();
                const nachname = $('#nachname').val();
                const benutzername = $('#benutzername').val();
                const email = $('#email').val();
                function passwortTrue(){
                    if (comparePasswords() == true){ //if both passwords are equal
                        return $('#passwort').val();
                    } else {
                        alert("FEHLER! Passwörter stimmen nicht überein!");
                    }
                }
                const passwort = passwortTrue();
                const sfrage = $('#sicherheitsfrage').val();
                const santwort = $('#sicherheitsantwort').val();
                const strassehausnr = $('#strasse').val();
                var plzInt = $('#plz').val();
                const plz = ''+plzInt;
                console.log("PLZ: " + typeof(plz));
                const wohnort = $('#ort').val();
                //var person = {anrede,vorname,nachname,benutzername,email,passwort,sfrage,santwort,strassehausnr,plz,wohnort};
                var person = { 'anrede':anrede, 'vorname':vorname, 'nachname':nachname, 'benutzername':benutzername, 'email':email, 'passwort':passwort, 
                        'sicherheitsfrage':sfrage, 'sicherheitsantwort':santwort, 'strassehausnr':strassehausnr, 'plz':plz, 'wohnort':wohnort };

                console.log('[inf] Formdata: ' + JSON.stringify(person));

                // send form with ajax
                $.ajax({
                    type: 'get',
                    method: 'post',
                    url: 'http://localhost:8000/wba2api/person',
                    contentType: 'application/json',
                    //contentType: false,
                    data: JSON.stringify(person)
                }).done(function(response){
                    console.log("[inf] success");
                    window.location.replace("anmeldung.html");

                }).fail(function(jqXHR,statusText,error){
                    console.log("[err] response code: " + jqXHR.status + "\nerror msg: " + jqXHR.responseText);
                });
                return false;
            });
        });
    </script>
    

    <!--
    <script>
        $('#registrierungsform').submit(function(event) {
            console.log("[STATUS] Ready!");

            //read form
            function checkedRadio(){
                const anrede = document.getElementsByName('anrede');
                for (i=0; i<anrede.length;i++){
                    if (anrede[i].checked){return anrede[i].value;}
                }
            }
            const anrede = checkedRadio();
            const vorname = document.getElementById('vorname').value;
            const nachname = document.getElementById('nachname').value;
            const benutzername = document.getElementById('benutzername').value;
            const email = document.getElementById('email').value;
            if (comparePasswords() == true){ //if both passwords are equal
                const passwort = document.getElementById('passwort').value;
            } else {
                alert("FEHLER! Passwörter stimmen nicht überein!");
            }
            const sfrage = document.getElementById('sicherheitsfrage').value;
            const santwort = document.getElementById('sicherheitsantwort').value;
            const strassehausnr = document.getElementById('strasse').value;
            const plz = document.getElementById('plz').value;
            const wohnort = document.getElementById('ort').value;
            daten = {anrede,vorname,nachname,benutzername,email,passwort,sfrage,santwort,strassehausnr,plz,wohnort};

            console.log('[INFO] Formdata: ', daten);


            // disable default event
            event.preventDefault();

            // convert data of form to object
            var form = document.getElementById('registrierungsform');
            var formData = new FormData(form);


            // send form with ajax
            $.ajax({
                url: 'http://localhost:8000/wba2api/person',
                type: 'POST',
                data: formData,
                /*contentType: false,
                cache: false,*/
                processData: false,
                dataType: 'json'
            })
            .done(function(response) {
                console.log('Response received' + response);
                for (i in response){
                    console.log(response[i]);
                }
                
                
                //read form
                function checkedRadio(){
                    const anrede = document.getElementsByName('anrede');
                    for (i=0; i<anrede.length;i++){
                        if (anrede[i].checked){return anrede[i].value;}
                    }
                }
                const anrede = checkedRadio();
                const vorname = document.getElementById('vorname').value;
                const nachname = document.getElementById('nachname').value;
                const benutzername = document.getElementById('benutzername').value;
                const email = document.getElementById('email').value;
                if (comparePasswords() == true){ //if both passwords are equal
                    const passwort = document.getElementById('passwort').value;
                } else {
                    alert("FEHLER! Passwörter stimmen nicht überein!");
                }
                const sfrage = document.getElementById('sicherheitsfrage').value;
                const santwort = document.getElementById('sicherheitsantwort').value;
                const strassehausnr = document.getElementById('strasse').value;
                const plz = document.getElementById('plz').value;
                const wohnort = document.getElementById('ort').value;
                data = {anrede,vorname,nachname,benutzername,email,passwort,sfrage,santwort,strassehausnr,plz,wohnort};

                console.log('[INFO] Formdata: ', data);
                
                
                
                
            })
            .fail(function(xhr) {
                console.log('error received');
                console.log(xhr);
                
            });
        });
    </script>
    -->

    <!--
    <script>
        console.log("[sta] Ready!");

        function clearValidationError() {
			$("#anrede").removeClass('invalid-input');
            $("#vorname").removeClass('invalid-input');
			$("#nachname").removeClass('invalid-input');
            $("#benutzername").removeClass('invalid-input');
			$("#email").removeClass('invalid-input');
			$("#password").removeClass('invalid-input');
            $("#password_wdh").removeClass('invalid-input');
            $("#sicherheitsfrage").removeClass('invalid-input');
            $("#sicherheitsantwort").removeClass('invalid-input');
			$("#strasse").removeClass('invalid-input');
			$("#plz").removeClass('invalid-input');
			$("#ort").removeClass('invalid-input');
			
		}

        async function submitData() {
            
            //read form
            function checkedRadio(){
                const anrede = document.getElementsByName('anrede');
                for (i=0; i<anrede.length;i++){
                    if (anrede[i].checked){return anrede[i].value;}
                }
            }
            const anrede = checkedRadio();
            const vorname = document.getElementById('vorname').value;
            const nachname = document.getElementById('nachname').value;
            const benutzername = document.getElementById('benutzername').value;
            const email = document.getElementById('email').value;
            if (comparePasswords() == true){ //if both passwords are equal
                const passwort = document.getElementById('passwort').value;
            } else {
                alert("FEHLER! Passwörter stimmen nicht überein!");
            }
            const sfrage = document.getElementById('sicherheitsfrage').value;
            const santwort = document.getElementById('sicherheitsantwort').value;
            const strassehausnr = document.getElementById('strasse').value;
            const plz = document.getElementById('plz').value;
            const wohnort = document.getElementById('ort').value;
            person = {anrede,vorname,nachname,benutzername,email,passwort,sfrage,santwort,strassehausnr,plz,wohnort};

            console.log('[inf] Formdata: ', person);

            var form = document.getElementById('registrierungsform');
            var formData = new FormData(form);

			const response = await fetch('http://localhost:8000/wba2api/person', {
				method: 'post',
				data: formData,
                processData: false,
                dataType: 'json',
                body: JSON.stringify(person)
			});
			console.log('[sta] ' + response.status);
			const text = await response.text();
			clearValidationError();
			console.log('[txt] '+ text);
			if (response.status === 400) {	// BAD REQUEST
				const payload = JSON.parse(text);
				const required = payload.daten;
				console.log('fehlercode: ', payload.nachricht);
				console.log('required: ', required);
				required.forEach(field => {
					const element = $("#" + field);
					if (!element.hasClass('invalid-input')) {
						element.addClass("invalid-input");
					}
				});
				window.alert('Die Daten sind nicht vollständig angegeben.');
				return;
			} else if (response.status === 409) {	// CONFLICT
				const payload = JSON.parse(text);
				if (payload.nachricht === 'EMAIL_ALREADY_IN_USED') {
					window.alert('Die angegebene Email Adresse wird bereits verwendet.');
					return;
				} else if (payload.nachricht === 'CHECK_EMAIL_FAILED') {
					window.alert('Ein Fehler ist aufgetreten.\nDie Email konnte nicht überprüft werden.');
					return;
				} else if (payload.nachricht === 'CREATE_ADRESS_FAILED') {
					window.alert('Ein Fehler ist aufgetreten.\nDie Kontaktadresse konnte nicht erstellt werden.');
					return;
				} else if (payload.nachricht === 'CREATE_PERSON_FAILED') {
					window.alert('Ein Fehler ist aufgetreten.\nDer Kontakt konnte nicht erstellt werden.');
					return;
				} else if (payload.nachricht === 'CREATE_PERSON_FAILED') {
					window.alert('Ein Fehler ist aufgetreten.\nDer Kontakt konnte nicht erstellt werden.');
					return;
				}			

				return;
			} else if (response.ok) {
				//window.location.replace("index.html");
			}

			
		}

    </script>
    -->


    <!--FUSSLEISTE-->
    <hr width="100%" style="color: #00336a; margin-top: 20px;">
    <div class="footbox">
        <footer>
            <!--Fussleiste oben-->
            <div class="footer_top">
                <div class="footer_top_kontakt">
                    <h3>Noch Fragen?</h3>
                    <text>&#129046 <a href="../HTML/kontakt.html">zum Kontaktformular</a></text>
                </div>

                <div class="footer_top_zahlung">
                    <h3>Zahlungsarten</h3>
                    <table>
                        <tr>
                            <td><img src="../Bilder/footer_mastercard_logo.png" alt="mastercard"></td>
                            <td><img src="../Bilder/footer_visa_logo.png" alt="visa"></td>
                        </tr>
                        <tr>
                            <td><img src="../Bilder/footer_sepa_logo.png" alt="sepa"></td>
                            <td><img src="../Bilder/footer_auf_rechnung_logo.png" alt="auf rechnung"></td>
                        </tr>
                    </table> 
                </div>

                <div class="footer_top_versand">
                    <h3>Versandpartner</h3>
                    <img src="../Bilder/footer_hermes_logo.png" alt="hermes">
                </div>

                <div class="footer_top_folgen">
                    <h3>Folge uns:</h3>
                    <a href="facebook.com"><img src="../Bilder/footer_facebook_logo.png" alt="facebook"></a>
                    <a href="instagram.com"><img src="../Bilder/footer_insta_logo.png" alt="instagram"></a>
                </div>

            </div>

            <!--Fussleiste unten-->
            <div class="footer_bottom">
                <div class="footer_bottom_kategorien">
                    <h3>Kategorien</h3>
                    <a href="../HTML/produkt_hauptseite.html" onclick="selectPath('Sale')">Sale %</a><br>
                    <a href="../HTML/produkt_hauptseite.html" onclick="selectPath('Männer')">Männer</a><br>
                    <a href="../HTML/produkt_hauptseite.html" onclick="selectPath('Frauen')">Frauen</a><br>
                    <a href="../HTML/produkt_hauptseite.html" onclick="selectPath('Sale')">Accessoires</a><br>
                </div>

                <div class="footer_bottom_rechtliches">
                    <h3>Rechtliches</h3>
                    <a href="../HTML/agb.html">AGB</a><br>
                    <a href="../HTML/impressum.html">Impressum</a><br>
                </div>

                <div class="footer_bottom_sponsoren">
                    <h3>Sponsoren & Partner</h3>
                    <a href="https://www.hs-albsig.de/hochschule/ueber-uns/hochschulportrait">
                        <img src="../Bilder/footer_hochschule_logo.png" alt="Hochschule">
                    </a><br>
                </div>

            </div>

        </footer>
    </div>
    <!--ENDE FUSSLEISTE-->
    

</body>

</html>
